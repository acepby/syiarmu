<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PSDM Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <style>
        .status-box { background: #e9ecef; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .limit-badge { font-size: 0.9em; margin-left: 10px; }
        #map { height: 500px; width: 100%; border-radius: 8px; border: 2px solid #ddd; margin-bottom: 20px; }
        .wc-container { height: 250px; width: 100%; position: relative; overflow: hidden; }

        /* --- FIXED MARKER CSS --- */
        .ping-wrapper { background: transparent; border: none; }
        .ping-inner {
            width: 100%; height: 100%;
            background-color: #0f0; border-radius: 50%;
            box-shadow: 0 0 10px #0f0;
            animation: pulse-green 1.5s infinite;
        }
        @keyframes pulse-green {
            0% { transform: scale(1); opacity: 1; }
            70% { transform: scale(2); opacity: 0; }
            100% { transform: scale(1); opacity: 0; }
        }
    </style>
</head>
<body class="bg-light">
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>üõ°Ô∏è Muhammadiyah Monitor</h2>
        <div>
            <button class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#addModal">‚ûï Add Target</button>
            <span class="badge bg-primary limit-badge">Hourly: <span id="limit-h">{{ limits.hourly }}</span></span>
            <span class="badge bg-warning text-dark limit-badge">Daily: <span id="limit-d">{{ limits.daily }}</span></span>
        </div>
    </div>
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}{% for category, message in messages %}<div class="alert alert-{{ category }} alert-dismissible fade show">{{ message }}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>{% endfor %}{% endif %}
    {% endwith %}

    <div class="status-box border-start border-4 border-info">
        <h5 class="text-info">ü§ñ Worker Status</h5>
        <p class="mb-1 fw-bold" id="worker-status">{{ status.status }}</p>
        <small class="text-muted" id="worker-log">{{ status.last_log }}</small>
    </div>

    <div class="card shadow-sm mb-4"><div class="card-header bg-white fw-bold">üó∫Ô∏è Live Activity Map</div><div class="card-body p-0"><div id="map"></div></div></div>

    <div class="card shadow-sm mb-4">
        <div class="card-header bg-white fw-bold">üìà Global Trends</div>
        <div class="card-body"><div style="height: 200px;"><canvas id="dailyChart"></canvas></div></div>
    </div>

    <div class="row mb-4">
        <div class="col-md-6"><div class="card shadow-sm"><div class="card-header bg-white fw-bold text-primary">‚òÅÔ∏è Trending (Website)</div><div class="card-body p-2"><div class="wc-container"><canvas id="webWordCloud"></canvas></div></div></div></div>
        <div class="col-md-6"><div class="card shadow-sm"><div class="card-header bg-white fw-bold text-danger">‚òÅÔ∏è Trending (Instagram)</div><div class="card-body p-2"><div class="wc-container"><canvas id="igWordCloud"></canvas></div></div></div></div>
    </div>

    <div class="card shadow-sm">
        <div class="card-header bg-dark text-white">Organization Data</div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover m-0">
                    <thead class="table-light"><tr><th>Organization</th><th>Status</th><th>Action</th></tr></thead>
                    <tbody id="orgTableBody">
                        {% for org in orgs %}
                        <tr>
                            <td><strong>{{ org.name }}</strong><br><small class="text-muted"><a href="{{ org.website_link }}" target="_blank">Web</a> | <a href="{{ org.instagram_link }}" target="_blank">IG</a></small></td>
                            <td>{% if org.last_scraped_at %} <small>{{ org.last_scraped_at.strftime('%d-%m %H:%M') }}</small> {% else %} <span class="badge bg-secondary">Pending</span> {% endif %}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-warning me-1" onclick="openEditModal('{{ org.id }}', '{{ org.name }}', '{{ org.website_link }}', '{{ org.instagram_link }}', '{{ org.latitude }}', '{{ org.longitude }}')">‚úèÔ∏è Edit</button>
                                <button class="btn btn-sm btn-outline-primary" onclick="showDetail({{ org.id }}, '{{ org.name }}')">üìä Detail</button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="addModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Add Target</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><form action="/add_org" method="POST"><div class="modal-body"><input type="text" name="name" class="form-control mb-2" placeholder="Name" required><input type="url" name="web_link" class="form-control mb-2" placeholder="Web Link"><input type="url" name="ig_link" class="form-control mb-2" placeholder="IG Link"><div class="row"><div class="col"><input type="number" step="any" name="lat" class="form-control" placeholder="Lat"></div><div class="col"><input type="number" step="any" name="lng" class="form-control" placeholder="Lng"></div></div></div><div class="modal-footer"><button type="submit" class="btn btn-primary">Save</button></div></form></div></div></div>

<div class="modal fade" id="editModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Edit Organization</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><form action="/edit_org" method="POST"><div class="modal-body"><input type="hidden" name="id" id="edit_id"><div class="mb-2"><label>Name</label><input type="text" name="name" id="edit_name" class="form-control" required></div><div class="mb-2"><label>Website Link</label><input type="url" name="web_link" id="edit_web" class="form-control"></div><div class="mb-2"><label>Instagram Link</label><input type="url" name="ig_link" id="edit_ig" class="form-control"></div><div class="row"><div class="col"><label>Latitude</label><input type="number" step="any" name="lat" id="edit_lat" class="form-control"></div><div class="col"><label>Longitude</label><input type="number" step="any" name="lng" id="edit_lng" class="form-control"></div></div></div><div class="modal-footer"><button type="submit" class="btn btn-warning">Update</button></div></form></div></div></div>

<div class="modal fade" id="detailModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="detailTitle">History</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="mb-4 border p-2 rounded"><canvas id="orgChart" height="100"></canvas></div><h6>Latest Posts</h6><div class="table-responsive" style="max-height: 300px; overflow-y: auto;"><table class="table table-sm table-striped"><thead><tr><th>Time</th><th>Source</th><th>Title</th></tr></thead><tbody id="detailTableBody"></tbody></table></div></div></div></div></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://unpkg.com/chartjs-chart-wordcloud@4.3.0/build/index.umd.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    //todo markercluster
    var map = L.map('map').setView([-2.5489, 118.0149], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 18 }).addTo(map);
    // Wadah untuk marker biasa (yang akan dicluster)
var markersCluster = L.markerClusterGroup(); 
map.addLayer(markersCluster);

// Registry (Buku Tamu)
var markers = {}; 

function updateMap() {
    $.get("/api/map_data", function(data) {
        data.forEach(org => {
            // --- LANGKAH A: Hapus marker lama ---
            if (markers[org.id]) {
                // Kita coba hapus dari KEDUA tempat karena kita tidak tahu
                // status dia sebelumnya (apakah VIP atau Cluster)
                markersCluster.removeLayer(markers[org.id]); 
                map.removeLayer(markers[org.id]); 
                delete markers[org.id];
            }

            // --- LANGKAH B: Tentukan Icon ---
            var icon;
            // Logic icon Anda...
            if (org.has_new) {
                icon = L.divIcon({ className: 'ping-wrapper', html: '<div class="ping-inner"></div>', iconSize: [6, 6], iconAnchor: [3, 3] });
            } else { 
                 // Logic Edukasi / Muh Icon Anda disalin kesini
                 const edu =['universitas','politeknik','akademi','sekolah'];
                 const isEdu = edu.some(e => org.name.toLowerCase().includes(e));
                 let imgUrl = isEdu ? "{{ url_for('static', filename='images/edu.png') }}" : "{{ url_for('static', filename='images/muh.png') }}";
                 
                 icon = L.icon({
                    iconUrl: imgUrl,
                    iconSize: [25, 41],
                    iconAnchor: [12, 41]
                });
            }

            // --- LANGKAH C: Buat Marker ---
            // PENTING: Jangan pakai .addTo() di sini dulu
            var marker = L.marker([org.lat, org.lng], {icon: icon}); 
            marker.bindPopup(`<b>${org.name}</b><br>...`);

            // --- LANGKAH D: Pisahkan Jalur Masuk (Logic Utama) ---
            if (org.has_new) {
                // JALUR VIP: Langsung ke Map (Bypass Cluster)
                // Agar animasi ping selalu terlihat & tidak tertumpuk
                marker.addTo(map); 
                // Opsional: set zIndexOffset tinggi agar di atas cluster
                marker.setZIndexOffset(1000); 
            } else {
                // JALUR UMUM: Masuk ke Cluster
                markersCluster.addLayer(marker);
            }

            // Simpan ke registry untuk penghapusan berikutnya
            markers[org.id] = marker;        
        });
    });
}
    updateMap(); setInterval(updateMap, 10000);

    const ctxDaily = document.getElementById('dailyChart').getContext('2d');
    let dailyChart = new Chart(ctxDaily, { type: 'line', data: { labels: {{ chart_dates | tojson }}, datasets: [{ label: 'Web', data: {{ chart_web | tojson }}, borderColor: 'blue', tension: 0.3 }, { label: 'IG', data: {{ chart_ig | tojson }}, borderColor: '#E1306C', tension: 0.3 }] }, options: { maintainAspectRatio: false } });

    let webWC = null, igWC = null;
    function renderWC(canvasId, labels, data, chartInstance) {
        if (!labels || labels.length === 0) return null;
        if (chartInstance) chartInstance.destroy();
        const maxVal = Math.max(...data), minVal = Math.min(...data);
        return new Chart(document.getElementById(canvasId).getContext('2d'), { type: 'wordCloud', data: { labels: labels, datasets: [{ label: 'Frekuensi', data: data.map(d => 10 + ((d - minVal) / (maxVal - minVal + 1)) * 20), fit: true }] }, options: { maintainAspectRatio: false, animation: false, plugins: { legend: { display: false } } } });
    }
    webWC = renderWC('webWordCloud', {{ web_wc_labels | tojson }}, {{ web_wc_data | tojson }}, webWC);
    igWC = renderWC('igWordCloud', {{ ig_wc_labels | tojson }}, {{ ig_wc_data | tojson }}, igWC);

    function updateVisuals() {
        $.get("/api/chart_data", function(data) {
            dailyChart.data.labels = data.dates; dailyChart.data.datasets[0].data = data.web_counts; dailyChart.data.datasets[1].data = data.ig_counts; dailyChart.update('none');
            webWC = renderWC('webWordCloud', data.web_wc_labels, data.web_wc_data, webWC);
            igWC = renderWC('igWordCloud', data.ig_wc_labels, data.ig_wc_data, igWC);
        });
    }
    setInterval(updateVisuals, 15000);

    function updateTable() {
        $.get("/api/table_data", function(data) {
            
            let rows = "";
            data.forEach(org => {
                let web = org.web_link || '', ig = org.ig_link || '';
                rows += `<tr><td><strong>${org.name}</strong><br><small class="text-muted"><a href="${web}" target="_blank">Web</a> | <a href="${ig}" target="_blank">IG</a></small></td><td><small>${org.last_scraped}</small></td><td><button class="btn btn-sm btn-outline-warning me-1" onclick="openEditModal('${org.id}', '${org.name}', '${web}', '${ig}', '${org.lat || ''}', '${org.lng || ''}')">‚úèÔ∏è Edit</button><button class="btn btn-sm btn-outline-primary" onclick="showDetail(${org.id}, '${org.name}')">üìä Detail</button></td></tr>`;
            });
            $("#orgTableBody").html(rows);
        });
    }
    setInterval(updateTable, 5000);

    window.openEditModal = function(id, name, web, ig, lat, lng) { $("#edit_id").val(id); $("#edit_name").val(name); $("#edit_web").val(web === 'None' ? '' : web); $("#edit_ig").val(ig === 'None' ? '' : ig); $("#edit_lat").val(lat === 'None' ? '' : lat); $("#edit_lng").val(lng === 'None' ? '' : lng); new bootstrap.Modal(document.getElementById('editModal')).show(); }

    let orgChartInstance = null;
    window.showDetail = function(orgId, orgName) {
        $("#detailTitle").text("History: " + orgName); $("#detailTableBody").html('<tr><td colspan="3" class="text-center">Loading...</td></tr>');
        new bootstrap.Modal(document.getElementById('detailModal')).show();
        $.get("/api/history/" + orgId, function(data) {
            let rows = ""; data.posts.forEach(p => { let color = p.source === 'Instagram' ? 'text-danger' : 'text-primary'; rows += `<tr><td><small>${p.time}</small></td><td class="${color}">${p.source}</td><td><a href="${p.url}" target="_blank">${p.title.substring(0,50)}...</a></td></tr>`; });
            $("#detailTableBody").html(rows || '<tr><td colspan="3">No posts found.</td></tr>');
            if (orgChartInstance) orgChartInstance.destroy();
            orgChartInstance = new Chart(document.getElementById('orgChart').getContext('2d'), { type: 'bar', data: { labels: data.chart.dates, datasets: [{ label: 'Web', data: data.chart.web, backgroundColor: 'blue' }, { label: 'IG', data: data.chart.ig, backgroundColor: '#E1306C' }] }, options: { scales: { x: { stacked: true }, y: { stacked: true } } } });
        });
    }
    setInterval(function(){ $.get("/api/status", function(data){ $("#worker-status").text(data.scan.status); $("#worker-log").text(data.scan.last_log); $("#limit-h").text(data.limits.hourly); }); }, 2000);
</script>
</body>
</html>